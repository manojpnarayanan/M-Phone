<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M Store - Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/shop.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* Navbar styling */
    .nav-link, .logout-btn {
      color: white !important;
    }
    .logout-btn:hover {
      color: #ccc !important;
    }

    /* Category section styling */
    .category-section {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 20px 0;
    }
    .category-card {
      text-align: center;
      width: 120px;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease-in-out;
    }
    .category-card:hover {
      transform: scale(1.1);
    }
    .category-card img {
      width: 100%;
      height: auto;
    }

    /* Product card styling */
    .card {
      transition: transform 0.3s ease-in-out;
      width: 100%;
      margin: auto;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .card:hover {
      transform: scale(1.03);
    }
    .card-img-top {
      width: 100%;
      height: 140px; /* Reduced height for a compact look */
      object-fit: cover;
    }
    .card-body {
      flex-grow: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 10px 15px;
    }
    .price-tag {
      font-size: 16px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 8px;
    }
    .add-to-cart {
      margin-top: auto;
    }

    /* Popup styling (if needed) */
    .popup-info {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 14px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease-in-out;
      white-space: nowrap;
    }
    .card:hover .popup-info {
      opacity: 1;
      visibility: visible;
      transform: translateY(-10px);
    }

    /* Sidebar styling */
    .sidebar {
      width: 250px;
      padding: 20px;
      background-color: #f8f9fa;
      border-right: 1px solid #ddd;
    }

    /* New Arrivals section */
    .new-arrivals {
      margin-top: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
    }

    /* Additional spacing for product grid */
    .row.products-row > [class*="col-"] {
      margin-bottom: 20px;
    }

    /* --- NEW FILTER ROW STYLES --- */
    .filter-row {
      margin: 20px 0;
    }
    .filter-row .form-label {
      font-weight: 500;
      margin-bottom: 5px;
    }
    .wishlist-icon {
  transition: color 0.3s ease-in-out;
}

.wishlist-icon:hover {
  color: #dc3545 !important; /* Red color on hover */
}
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">M Store</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/user/dashboard">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="/user/dashboard/shopping">Shop</a></li>
          <li class="nav-item"><a class="nav-link" href="/user/myprofile/<%= user._id %>">My Profile</a></li>
          <li class="nav-item">
            <form id="logoutForm" action="/user/logout" method="post">
              <button type="submit" class="btn btn-dark logout-btn ms-3">Logout</button>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </nav>
   
  <!-- Search Bar -->
  <div class="container d-flex justify-content-center mt-3">
    <form action="/user/dashboard/shopping" method="get" class="d-flex w-33">
      <input type="text" name="search" class="form-control me-2" placeholder="Search products..." value="<%= search || '' %>">
      <button type="submit" class="btn btn-dark">Search</button>
    </form>
  </div>
    
  <!-- Unified Filter Row -->
 <!-- Unified Filter Row -->
 <div class="container filter-row">
    <div class="row align-items-end">
      <!-- Left: New Filters -->
      <div class="col-md-8">
        <div class="row g-3 align-items-end">
          <!-- Price Range Filter -->
          <div class="col-md-4">
            <label for="priceRange" class="form-label">Price Range</label>
            <input type="range" class="form-range" id="priceRange" min="0" max="100000" step="1000" onchange="applyFilters()">
            <p class="mb-0">₹<span id="priceValue">0</span></p>
          </div>
          <!-- Category Filter -->
          <div class="col-md-4">
            <label for="categoryFilter" class="form-label">Category</label>
            <select class="form-select" id="categoryFilter" onchange="applyFilters()">
              <option value="all">All Categories</option>
              <option value="premium">Premium Phones</option>
              <option value="business">Business Phones</option>
              <option value="featured">Featured Phones</option>
            </select>
          </div>
          <!-- Brand Filter -->
          <div class="col-md-4">
            <label for="brandFilter" class="form-label">Brand</label>
            <select class="form-select" id="brandFilter" onchange="applyFilters()">
              <option value="all">All Brands</option>
              <option value="apple">Apple</option>
              <option value="samsung">Samsung</option>
              <option value="oneplus">OnePlus</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Right: Sort Dropdown -->
      <div class="col-md-4 d-flex align-items-end">
        <div class="w-100">
          <label for="sort" class="form-label mb-1">Sort By</label>
          <select id="sort" class="form-select" onchange="window.location.href='/user/dashboard/shopping?sort=' + this.value;">
            <option value="price_low_to_high" <%= sort === 'price_low_to_high' ? 'selected' : '' %>>Price: Low to High</option>
            <option value="price_high_to_low" <%= sort === 'price_high_to_low' ? 'selected' : '' %>>Price: High to Low</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  
  

  <!-- Category Section (if needed) -->
  <!-- (Currently commented out, as per your code) -->

  <!-- Main Content -->
  <section class="container my-5">
    <h2 class="text-center mb-4">Shop All Products</h2>
    <div class="row row-cols-1 row-cols-md-4 g-4 justify-content-center">
      <% if (products && products.length > 0) { %>
        <% products.forEach(product => { %>
          <div class="col">
            <div class="card h-100 mx-auto" style="max-width: 80%;">
              <a href="/user/dashboard/products/<%= product._id %>">
                <div class="position-relative">
                  <% if (product.image && product.image.length > 0) { %>
                    <img src="/<%= product.image[0] %>" class="card-img-top" alt="<%= product.name %>">
                  <% } else { %>
                    <img src="/images/default.png" class="card-img-top" alt="No Image Available">
                  <% } %>
                  <% if (product.sale) { %>
                    <span class="badge bg-danger position-absolute top-0 end-0 m-2">SALE</span>
                  <% } %>
                </div>
                <div class="card-body d-flex flex-column">
                  <h5 class="fw-bold"><%= product.name %></h5>
                  <p class="text-muted mb-3"><%= product.description.substring(0, 50) %>...</p>
                  <p class="price-tag">₹<%= product.price %></p>
                  <button class="btn btn-dark btn-sm mt-auto add-to-cart">Add to Cart</button>
                </div>
              </a>
               <!-- Wishlist Icon -->
    <div class="position-absolute top-0 start-0 m-2">
        <i 
          class="fa-heart wishlist-icon <%= product.isInWishlist ? 'fas text-danger' : 'far' %>" 
          style="cursor: pointer; font-size: 1.5rem;" 
          data-product-id="<%= product._id %>"
          onclick="toggleWishlist('<%= product._id %>')"
        ></i>
      </div>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p class="text-center">No products available.</p>
      <% } %>
    </div>
  </section>
  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-4">
    <nav>
      <ul class="pagination">
        <% if (currentPage > 1) { %>
          <li class="page-item">
            <a class="page-link" href="/user/dashboard/shopping?page=<%= currentPage - 1 %>&search=<%= search || '' %>&sort=<%= sort || '' %>">Previous</a>
          </li>
        <% } %>
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="/user/dashboard/shopping?page=<%= i %>&search=<%= search || '' %>&sort=<%= sort || '' %>"><%= i %></a>
          </li>
        <% } %>
        <% if (currentPage < totalPages) { %>
          <li class="page-item">
            <a class="page-link" href="/user/dashboard/shopping?page=<%= currentPage + 1 %>&search=<%= search || '' %>&sort=<%= sort || '' %>">Next</a>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
  
  <footer class="bg-dark text-white py-4">
    <div class="container text-center">
      <p>&copy; 2025 M Store. All rights reserved.</p>
    </div>
  </footer>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Update price range value
    // const priceRange = document.getElementById('priceRange');
    // const priceValue = document.getElementById('priceValue');
    // if(priceRange && priceValue){
    //   priceRange.addEventListener('input', () => {
    //     priceValue.textContent = priceRange.value;
    //   });
    // }
    function applyFilters(){
        const priceRange = document.getElementById('priceRange').value;
        const category = document.getElementById('categoryFilter').value;
        const brand = document.getElementById('brandFilter').value;

        const queryParams = new URLSearchParams({
      price: priceRange,
      category: category,
      brand: brand,
    });
    window.location.href = `/user/dashboard/shopping?${queryParams.toString()}`;
    }
     // Update price range value display
  const priceRangeInput = document.getElementById('priceRange');
  const priceValues = document.getElementById('priceValue');
  if (priceRangeInput && priceValues) {
    priceRangeInput.addEventListener('input', () => {
      priceValues.textContent = priceRangeInput.value;
    });
  }
  async function toggleWishlist(productId){
    try{
        
       const response=await fetch(`/user/dashboard/shopping/${productId}`,{
        method:"POST",
        headers:{
            "Content-Type":"application/json"
        }
       })
       if (response.ok) {
        const data = await response.json();
        const wishlistIcon = document.querySelector(`.wishlist-icon[data-product-id='${productId}']`);

        // Toggle the icon class
        if (data.isInWishlist) {
          wishlistIcon.classList.remove('far');
          wishlistIcon.classList.add('fas', 'text-danger');
        } else {
          wishlistIcon.classList.remove('fas', 'text-danger');
          wishlistIcon.classList.add('far');
        }
      } else {
        console.error('Failed to toggle wishlist');
      }
    }catch(error){
        console.log(error)
    }
  }


  </script>
</body>
</html>
