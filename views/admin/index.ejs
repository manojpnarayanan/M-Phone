
<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>M phone Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/imgs/theme/favicon.svg">
    <!-- Template CSS -->
    <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div class="screen-overlay"></div>
    <%- include('./partials/nav') %>
    <main class="main-wrap">
        <section class="content-main">
            <div class="content-header flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Analytics Dashboard</h2>
                    <p class="text-gray-500">Comprehensive business insights</p>
                </div>
                <div>
                    <form method="get" class="flex items-center">
                        <select name="timeFilter" id="timeFilterSelect" class="form-select border rounded px-3 py-2 mr-2"
                                onchange="this.form.submit()">
                            <option value="yearly" <%= timeFilter === 'yearly' ? 'selected' : '' %>>Yearly</option>
                            <option value="monthly" <%= timeFilter === 'monthly' ? 'selected' : '' %>>Monthly</option>
                            <option value="weekly" <%= timeFilter === 'weekly' ? 'selected' : '' %>>Weekly</option>
                            <option value="daily" <%= timeFilter === 'daily' ? 'selected' : '' %>>Daily</option>
                        </select>
                    </form>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="row mb-6">
                <div class="col-3">
                    <div class="bg-white shadow rounded p-4">
                        <h3 class="text-lg font-semibold">₹<%= revenue.toLocaleString() %></h3>
                        <p class="text-gray-500">Total Revenue</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="bg-white shadow rounded p-4">
                        <h3 class="text-lg font-semibold"><%= totalOrders.toLocaleString() %></h3>
                        <p class="text-gray-500">Total Orders</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="bg-white shadow rounded p-4">
                        <h3 class="text-lg font-semibold"><%= totalUsers.toLocaleString() %></h3>
                        <p class="text-gray-500">Total Users</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="bg-white shadow rounded p-4">
                        <h3 class="text-lg font-semibold">₹<%= avgOrderValue.toLocaleString() %></h3>
                        <p class="text-gray-500">Avg Order Value</p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-100 rounded p-4 mb-6 h-32">
                <p class="text-gray-500 text-center">Chat Interface Placeholder</p>
            </div>

            <!-- Sales Chart (using Chart.js) -->
            <div class="bg-white shadow rounded mb-6 p-4">
                <h3 class="text-xl font-semibold mb-4">Sales Performance</h3>
                <canvas id="salesChart" height="150"></canvas>
                <div id="chartDetails" class="mt-4 text-gray-600 text-center"></div>
            </div>

            

            <!-- Top Performers -->
            <div class="grid grid-cols-3 gap-4">
                <!-- Top Products -->
                <div class="bg-white shadow rounded p-4">
                    <h3 class="text-xl font-semibold mb-4">Top Products</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left">Product</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% topProducts.forEach(product => { %>
                            <tr class="border-b">
                                <td><%= product.name %></td>
                                <td class="text-right"><%= product.totalQuantity %></td>
                                <td class="text-right">₹<%= product.totalRevenue.toLocaleString() %></td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <!-- Top Categories -->
                <div class="bg-white shadow rounded p-4">
                    <h3 class="text-xl font-semibold mb-4">Top Categories</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left">Category</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% topCategories.forEach(category => { %>
                            <tr class="border-b">
                                <td><%= category.name %></td>
                                <td class="text-right"><%= category.totalQuantity %></td>
                                <td class="text-right">₹<%= category.totalRevenue.toLocaleString() %></td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <!-- Top Brands -->
                <div class="bg-white shadow rounded p-4">
                    <h3 class="text-xl font-semibold mb-4">Top Brands</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left">Brand</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% topBrands.forEach(brand => { %>
                            <tr class="border-b">
                                <td><%= brand.name %></td>
                                <td class="text-right"><%= brand.totalQuantity %></td>
                                <td class="text-right">₹<%= brand.totalRevenue.toLocaleString() %></td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <footer class="main-footer font-xs">
            <div class="row pb-30 pt-15">
                <div class="col-sm-6">
                    <%= new Date().getFullYear() %> © Dashboard
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end">
                        All rights reserved
                    </div>
                </div>
            </div>
        </footer>
    </main>
    <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/vendors/select2.min.js"></script>
    <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/assets/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="/assets/js/main.js" type="text/javascript"></script>
    <script src="/assets/js/custom-chart.js" type="text/javascript"></script>
</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
     const salesData = <%- JSON.stringify(ordersData) %>;
    const timeFilter = '<%= timeFilter %>';
    const ctx = document.getElementById('salesChart').getContext('2d');
    const chartDetailsEl = document.getElementById('chartDetails');

    // Function to format labels based on time filter
    function formatLabels(data, filter) {
        return data.map(item => {
            const date = new Date(item._id);
            switch(filter) {
                case 'yearly':
                    return date.toLocaleString('default', { month: 'short' });
                case 'monthly':
                    return `Week ${date.getWeek()}`;
                case 'weekly':
                    return date.toLocaleDateString();
                case 'daily':
                    return date.toLocaleDateString();
                default:
                    return item._id.toString();
            }
        });
    }
     // Extend Date prototype to get week number
     Date.prototype.getWeek = function() {
        var date = new Date(this.getTime());
        date.setHours(0, 0, 0, 0);
        date.setDate(date.getDate() + 4 - (date.getDay() || 7));
        var yearStart = new Date(date.getFullYear(), 0, 1);
        var weekNo = Math.ceil(((date - yearStart) / 86400000 + 1) / 7);
        return weekNo;
    };

    // Function to get date range details
    function getDateRangeDetails(data, filter) {
        if (data.length === 0) return 'No data available';

        switch(filter) {
            case 'yearly':
                return `Yearly View: All Months Breakdown`;
            case 'monthly':
                return `Monthly View: All Weeks Breakdown`;
            case 'weekly':
                return `Weekly View: Daily Performance`;
            case 'daily':
                return `Daily View: Detailed Performance`;
            default:
                return 'Performance Overview';
        }
    }

    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: formatLabels(salesData, timeFilter),
            datasets: [
                {
                    label: 'Total Orders',
                    data: salesData.map(item => item.totalOrders),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Total Revenue (₹)',
                    data: salesData.map(item => item.totalRevenue),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: getDateRangeDetails(salesData, timeFilter)
                }
            }
        }
    });

    // Update chart details
    chartDetailsEl.textContent = getDateRangeDetails(salesData, timeFilter);

    // Optional: Add interactivity to update chart details when filter changes
    document.getElementById('timeFilterSelect').addEventListener('change', function() {
        const selectedFilter = this.value;
        chart.data.labels = formatLabels(salesData, selectedFilter);
        chart.options.plugins.title.text = getDateRangeDetails(salesData, selectedFilter);
        chartDetailsEl.textContent = getDateRangeDetails(salesData, selectedFilter);
        chart.update();
    });
</script>

